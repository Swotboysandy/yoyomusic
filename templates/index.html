<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <title>YoYo Music</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&display=swap"
    rel="stylesheet">
  <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
  <script src="https://www.youtube.com/iframe_api"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Space Grotesk', sans-serif;
      background: #000;
      color: #fff;
      min-height: 100vh;
    }

    /* Login */
    .login-container {
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      padding: 20px;
    }

    .login-card {
      background: #0a0a0a;
      border: 1px solid #222;
      border-radius: 12px;
      padding: 40px;
      width: 100%;
      max-width: 340px;
      text-align: center;
    }

    .login-card h1 {
      font-size: 24px;
      font-weight: 600;
      margin-bottom: 6px;
    }

    .login-card p {
      color: #666;
      font-size: 14px;
      margin-bottom: 28px;
    }

    input[type="text"] {
      display: block;
      width: 100%;
      padding: 14px 20px;
      background: #1a1a1a;
      border: 2px solid #333;
      border-radius: 12px;
      color: #ffffff;
      font-size: 16px;
      font-family: sans-serif;
      margin-bottom: 20px;
      outline: none;
      text-align: left;
      caret-color: #ffffff;
      position: relative;
      z-index: 5;
    }

    input[type="text"]:focus {
      border-color: #ffffff;
      background: #222222;
    }

    input[type="text"]::placeholder {
      color: #666666;
    }

    .btn {
      padding: 12px 20px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      font-family: inherit;
      cursor: pointer;
      transition: all 0.15s;
    }

    .btn-white {
      background: #fff;
      color: #000;
    }

    .btn-white:hover {
      background: #eee;
    }

    .btn-dark {
      background: #1a1a1a;
      color: #fff;
      border: 1px solid #333;
    }

    .btn-dark:hover {
      background: #222;
    }

    /* App */
    .app-container {
      display: none;
    }

    .app-container.active {
      display: block;
    }

    /* Header */
    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 24px;
      border-bottom: 1px solid #1a1a1a;
      background: #000;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .header h1 {
      font-size: 16px;
      font-weight: 600;
    }

    .online-count {
      font-size: 13px;
      color: #666;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .online-dot {
      width: 6px;
      height: 6px;
      background: #4f4;
      border-radius: 50%;
    }

    /* Main Layout */
    .main {
      max-width: 900px;
      margin: 0 auto;
      padding: 24px;
      padding-bottom: 120px;
    }

    /* Search Bar */
    .search-bar {
      display: flex;
      gap: 12px;
      margin-bottom: 24px;
    }

    .search-bar input {
      flex: 1 1 auto;
      min-width: 200px;
      width: 100%;
      padding: 16px 20px;
      background: #1a1a1a;
      border: 2px solid #333;
      border-radius: 12px;
      color: #ffffff;
      font-size: 16px;
      font-family: sans-serif;
      outline: none;
      caret-color: #ffffff;
    }

    .search-bar input:focus {
      outline: none;
      border-color: #555;
      background: #222;
    }

    .search-bar input::placeholder {
      color: #777;
    }

    .search-bar .btn {
      padding: 16px 24px;
      font-size: 14px;
      white-space: nowrap;
    }

    /* Sections */
    .section {
      background: #0a0a0a;
      border: 1px solid #1a1a1a;
      border-radius: 10px;
      padding: 16px;
      margin-bottom: 16px;
    }

    .section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
      padding-bottom: 12px;
      border-bottom: 1px solid #1a1a1a;
    }

    .section-title {
      font-size: 13px;
      font-weight: 500;
      color: #888;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .section-count {
      font-size: 12px;
      color: #555;
    }

    /* Song List */
    .song-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
      max-height: 350px;
      overflow-y: auto;
    }

    .song-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px;
      background: #111;
      border-radius: 8px;
      transition: background 0.15s;
    }

    .song-item:hover {
      background: #181818;
    }

    .song-thumb {
      width: 48px;
      height: 36px;
      background: #1a1a1a;
      border-radius: 4px;
      overflow: hidden;
      flex-shrink: 0;
    }

    .song-thumb img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .song-info {
      flex: 1;
      min-width: 0;
    }

    .song-title {
      font-size: 14px;
      font-weight: 500;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      color: #fff;
    }

    .song-channel {
      font-size: 12px;
      color: #666;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .song-add {
      padding: 6px 14px;
      background: #222;
      border: none;
      border-radius: 6px;
      color: #fff;
      font-size: 13px;
      font-family: inherit;
      cursor: pointer;
      transition: background 0.15s;
    }

    .song-add:hover {
      background: #333;
    }

    /* Queue Item */
    .queue-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px;
      background: #111;
      border-radius: 8px;
    }

    .queue-num {
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #1a1a1a;
      border-radius: 4px;
      font-size: 11px;
      color: #666;
      flex-shrink: 0;
    }

    .queue-title {
      flex: 1;
      font-size: 13px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* Users */
    .user-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px;
      background: #111;
      border-radius: 8px;
    }

    .user-avatar {
      width: 28px;
      height: 28px;
      background: #333;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: 600;
    }

    .user-name {
      flex: 1;
      font-size: 13px;
    }

    /* Empty State */
    .empty {
      text-align: center;
      padding: 24px;
      color: #444;
      font-size: 13px;
    }

    /* Loading */
    .loading {
      text-align: center;
      padding: 24px;
      color: #666;
      font-size: 13px;
    }

    /* Player Bar */
    .player-bar {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: #0a0a0a;
      border-top: 1px solid #1a1a1a;
      padding: 12px 24px;
      z-index: 1000;
    }

    .player-content {
      max-width: 900px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 20px;
    }

    .player-info {
      display: flex;
      align-items: center;
      gap: 12px;
      flex: 1;
      min-width: 0;
    }

    .player-thumb {
      width: 44px;
      height: 44px;
      background: #1a1a1a;
      border-radius: 6px;
      overflow: hidden;
      flex-shrink: 0;
    }

    .player-thumb img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: none;
    }

    .player-text {
      flex: 1;
      min-width: 0;
    }

    .player-title {
      font-size: 13px;
      font-weight: 500;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .player-status {
      font-size: 11px;
      color: #666;
    }

    /* Controls */
    .player-controls {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 16px;
      min-width: 140px;
    }

    .ctrl-btn {
      width: 40px;
      height: 40px;
      min-width: 40px;
      min-height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: transparent;
      border: none;
      border-radius: 50%;
      color: #888;
      cursor: pointer;
      font-size: 16px;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      padding: 0;
      flex-shrink: 0;
      position: relative;
    }

    .ctrl-btn:hover {
      color: #fff;
      background: rgba(255, 255, 255, 0.05);
    }

    .ctrl-btn.main {
      width: 48px;
      height: 48px;
      min-width: 48px;
      min-height: 48px;
      background: #fff;
      color: #000;
      font-size: 20px;
      box-shadow: 0 4px 12px rgba(255, 255, 255, 0.1);
    }

    .ctrl-btn.main:hover {
      background: #f0f0f0;
      transform: scale(1.05);
    }

    .ctrl-btn:active {
      transform: scale(0.95);
    }

    /* Progress */
    .progress-wrap {
      display: flex;
      align-items: center;
      gap: 8px;
      flex: 2;
      max-width: 400px;
    }

    .progress-time {
      font-size: 11px;
      color: #555;
      min-width: 32px;
      font-variant-numeric: tabular-nums;
    }

    .progress-bar {
      flex: 1;
      height: 4px;
      background: #222;
      border-radius: 2px;
      cursor: pointer;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      background: #fff;
      width: 0%;
    }

    /* Volume */
    .volume-wrap {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .volume-slider {
      width: 70px;
      height: 4px;
      -webkit-appearance: none;
      background: #222;
      border-radius: 2px;
      cursor: pointer;
    }

    .volume-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 10px;
      height: 10px;
      background: #fff;
      border-radius: 50%;
    }

    /* Toast */
    .toast {
      position: fixed;
      bottom: 100px;
      left: 50%;
      transform: translateX(-50%) translateY(20px);
      padding: 10px 18px;
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 8px;
      font-size: 13px;
      color: #ccc;
      opacity: 0;
      transition: all 0.2s;
      z-index: 1001;
    }

    .toast.show {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }

    /* Grid layout for larger screens */
    @media (min-width: 700px) {
      .grid {
        display: grid;
        grid-template-columns: 1fr 280px;
        gap: 16px;
      }
    }

    /* Scrollbar */
    ::-webkit-scrollbar {
      width: 6px;
    }

    ::-webkit-scrollbar-track {
      background: transparent;
    }

    ::-webkit-scrollbar-thumb {
      background: #333;
      border-radius: 3px;
    }

    /* Hide YT player */
    #player {
      position: absolute;
      width: 0;
      height: 0;
      overflow: hidden;
    }

    @media (max-width: 600px) {
      .main {
        padding: 16px;
      }

      .volume-wrap {
        display: none;
      }

      .progress-wrap {
        max-width: 200px;
      }
    }
  </style>
</head>

<body>
  <!-- Lobby -->
  <div class="login-container" id="lobby">
    <div class="login-card" style="max-width: 420px;">
      <h1>YoYo Music</h1>
      <p>Listen together in rooms</p>

      <input type="text" id="username" placeholder="Your name" maxlength="20" autocomplete="off">

      <div style="margin-bottom: 20px;">
        <div style="font-size: 13px; color: #888; margin-bottom: 12px;">Available Rooms</div>
        <div id="room_list" style="max-height: 200px; overflow-y: auto;">
          <div class="empty" style="color: #666; font-size: 14px; padding: 20px 0;">Loading rooms...</div>
        </div>
      </div>

      <div style="border-top: 1px solid #222; padding-top: 20px; margin-top: 10px;">
        <div style="font-size: 13px; color: #888; margin-bottom: 12px;">Create New Room</div>
        <input type="text" id="new_room_name" placeholder="Room name" maxlength="30" autocomplete="off">
        <input type="password" id="new_room_password" placeholder="Password (optional)" maxlength="20"
          autocomplete="off"
          style="background: #1a1a1a; border: 2px solid #333; border-radius: 12px; color: #fff; padding: 14px 20px; width: 100%; margin-bottom: 12px; font-family: sans-serif; font-size: 16px; outline: none;">
        <button class="btn btn-white" style="width:100%" onclick="createRoom()">Create Room</button>
      </div>
    </div>
  </div>

  <!-- Password Modal -->
  <div id="password_modal"
    style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 2000; align-items: center; justify-content: center;">
    <div class="login-card" style="max-width: 320px;">
      <h2 style="font-size: 18px; margin-bottom: 16px;">Enter Password</h2>
      <p id="modal_room_name" style="color: #888; margin-bottom: 16px;"></p>
      <input type="password" id="join_password" placeholder="Room password" autocomplete="off"
        style="background: #1a1a1a; border: 2px solid #333; border-radius: 12px; color: #fff; padding: 14px 20px; width: 100%; margin-bottom: 12px; font-family: sans-serif; font-size: 16px; outline: none;">
      <div style="display: flex; gap: 10px;">
        <button class="btn btn-dark" style="flex: 1;" onclick="closePasswordModal()">Cancel</button>
        <button class="btn btn-white" style="flex: 1;" onclick="submitPassword()">Join</button>
      </div>
    </div>
  </div>

  <!-- App -->
  <div class="app-container" id="app">
    <header class="header">
      <div style="display: flex; align-items: center; gap: 12px;">
        <h1>YoYo Music</h1>
        <span id="room_name_display" style="color: #666; font-size: 14px; font-weight: 400;"></span>
      </div>
      <div style="display: flex; align-items: center; gap: 16px;">
        <div class="online-count">
          <span class="online-dot"></span>
          <span id="user_count">0 online</span>
        </div>
        <button class="btn btn-dark" onclick="leaveRoom()" style="padding: 8px 16px; font-size: 13px;">Exit</button>
      </div>
    </header>

    <main class="main">
      <div class="search-bar">
        <input type="text" id="search_input" placeholder="Search for songs..."
          onkeydown="if(event.key==='Enter')search()" autocomplete="off">
        <button class="btn btn-dark" onclick="search()">Search</button>
      </div>

      <div class="grid">
        <div class="left">
          <div class="section" id="search_section" style="display:none">
            <div class="section-header">
              <span class="section-title">Search Results</span>
              <button class="btn btn-dark" style="padding:6px 12px;font-size:12px"
                onclick="clearSearch()">Clear</button>
            </div>
            <div class="song-list" id="search_results"></div>
          </div>

          <div class="section">
            <div class="section-header">
              <span class="section-title">Queue</span>
              <span class="section-count" id="queue_count">0 songs</span>
            </div>
            <div class="song-list" id="queue_list">
              <div class="empty">No songs in queue</div>
            </div>
          </div>
        </div>

        <div class="right">
          <div class="section">
            <div class="section-header">
              <span class="section-title">Listeners</span>
            </div>
            <div class="song-list" id="user_list">
              <div class="empty">No listeners</div>
            </div>
          </div>

          <div class="section">
            <div class="section-header">
              <span class="section-title">Now Playing</span>
            </div>
            <div id="now_playing_card">
              <div class="empty">Nothing playing</div>
            </div>
          </div>
        </div>
      </div>
    </main>

    <div class="player-bar">
      <div class="player-content">
        <div class="player-info">
          <div class="player-thumb">
            <img id="thumb" src="" alt="">
          </div>
          <div class="player-text">
            <div class="player-title" id="player_title">Not playing</div>
            <div class="player-status" id="player_status">Ready</div>
          </div>
        </div>

        <div class="player-controls">
          <button class="ctrl-btn" onclick="vote()">‚è≠</button>
          <button class="ctrl-btn main" id="play_btn" onclick="toggle()">‚ñ∂</button>
          <button class="ctrl-btn" onclick="vote()">üëé</button>
        </div>

        <div class="progress-wrap">
          <span class="progress-time" id="time_cur">0:00</span>
          <div class="progress-bar" onclick="seek(event)">
            <div class="progress-fill" id="progress"></div>
          </div>
          <span class="progress-time" id="time_tot">0:00</span>
        </div>

        <div class="volume-wrap">
          <button class="ctrl-btn" onclick="mute()" id="vol_btn">üîä</button>
          <input type="range" class="volume-slider" min="0" max="100" value="80" onchange="setVol(this.value)">
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>
  <div id="player"></div>

  <script>
    const socket = io();
    let yt, ready = false, playing = false, vol = 80;
    let currentRoomId = null;
    let pendingRoomId = null;

    // Request room list on connect
    socket.on('connect', () => {
      socket.emit('get_rooms');
    });

    // Room list update
    socket.on('room_list', rooms => {
      const el = document.getElementById('room_list');
      if (!rooms.length) {
        el.innerHTML = '<div class="empty" style="color: #666; font-size: 14px; padding: 20px 0;">No rooms yet. Create one!</div>';
        return;
      }
      el.innerHTML = rooms.map(r => `
      <div onclick="tryJoinRoom('${r.id}', '${esc(r.name)}', ${r.has_password})" style="display: flex; justify-content: space-between; align-items: center; padding: 12px 16px; background: #111; border-radius: 8px; margin-bottom: 8px; cursor: pointer; transition: background 0.2s;" onmouseover="this.style.background='#1a1a1a'" onmouseout="this.style.background='#111'">
        <div>
          <div style="font-size: 14px; font-weight: 500;">${esc(r.name)}</div>
          <div style="font-size: 12px; color: #666;">${r.user_count} listener${r.user_count !== 1 ? 's' : ''}</div>
        </div>
        <div style="font-size: 16px;">${r.has_password ? 'üîí' : '‚Üí'}</div>
      </div>
    `).join('');
    });

    function createRoom() {
      const username = document.getElementById('username').value.trim();
      if (!username) return toast('Enter your name first');

      const name = document.getElementById('new_room_name').value.trim();
      if (!name) return toast('Enter room name');

      const password = document.getElementById('new_room_password').value;
      socket.emit('create_room', { name, password });
    }

    socket.on('room_created', data => {
      const username = document.getElementById('username').value.trim();
      socket.emit('join_room', { room_id: data.id, username, password: document.getElementById('new_room_password').value });
    });

    function tryJoinRoom(roomId, roomName, hasPassword) {
      const username = document.getElementById('username').value.trim();
      if (!username) return toast('Enter your name first');

      if (hasPassword) {
        pendingRoomId = roomId;
        document.getElementById('modal_room_name').textContent = roomName;
        document.getElementById('password_modal').style.display = 'flex';
        document.getElementById('join_password').focus();
      } else {
        socket.emit('join_room', { room_id: roomId, username, password: '' });
      }
    }

    function closePasswordModal() {
      document.getElementById('password_modal').style.display = 'none';
      document.getElementById('join_password').value = '';
      pendingRoomId = null;
    }

    function submitPassword() {
      const username = document.getElementById('username').value.trim();
      const password = document.getElementById('join_password').value;
      socket.emit('join_room', { room_id: pendingRoomId, username, password });
      closePasswordModal();
    }

    socket.on('room_error', msg => toast(msg));

    socket.on('joined_room', data => {
      currentRoomId = data.room_id;
      document.getElementById('lobby').style.display = 'none';
      document.getElementById('app').classList.add('active');
      document.getElementById('room_name_display').textContent = '‚Ä¢ ' + data.room_name;
    });

    function leaveRoom() {
      socket.emit('leave_current_room');
    }

    socket.on('left_room', () => {
      currentRoomId = null;
      document.getElementById('app').classList.remove('active');
      document.getElementById('lobby').style.display = 'flex';
      document.getElementById('room_name_display').textContent = '';
      // Reset player
      if (yt && ready) {
        yt.stopVideo();
      }
      document.getElementById('player_title').textContent = 'Not playing';
      document.getElementById('thumb').style.display = 'none';
      document.getElementById('queue_list').innerHTML = '<div class="empty">No songs in queue</div>';
      document.getElementById('user_list').innerHTML = '<div class="empty">No listeners</div>';
    });

    function search() {
      const q = document.getElementById('search_input').value.trim();
      if (!q) return;
      document.getElementById('search_section').style.display = 'block';
      document.getElementById('search_results').innerHTML = '<div class="loading">Searching...</div>';
      socket.emit('search', q);
    }

    function clearSearch() {
      document.getElementById('search_input').value = '';
      document.getElementById('search_section').style.display = 'none';
    }

    function add(song) {
      socket.emit('add_to_queue', song);
      toast('Added to queue');
    }

    function toggle() { socket.emit('play_pause'); }
    function vote() { socket.emit('vote_skip'); toast('Vote skip'); }

    function mute() {
      if (!yt || !ready) return;
      yt.isMuted() ? yt.unMute() : yt.mute();
      document.getElementById('vol_btn').textContent = yt.isMuted() ? 'üîá' : 'ÔøΩ';
    }

    function setVol(v) { vol = v; if (yt && ready) yt.setVolume(v); }

    function seek(e) {
      if (!yt || !ready) return;
      const r = e.target.getBoundingClientRect();
      yt.seekTo(yt.getDuration() * ((e.clientX - r.left) / r.width), true);
    }

    function fmt(s) {
      const m = Math.floor(s / 60);
      return m + ':' + Math.floor(s % 60).toString().padStart(2, '0');
    }

    function onYouTubeIframeAPIReady() {
      yt = new YT.Player('player', {
        height: '0', width: '0', videoId: '',
        playerVars: { autoplay: 1 },
        events: {
          onReady: () => { ready = true; yt.setVolume(vol); },
          onError: () => { document.getElementById('player_status').textContent = 'Error'; setTimeout(() => socket.emit('song_ended'), 1000); },
          onStateChange: e => {
            const s = { '-1': 'Loading', 0: 'Ended', 1: 'Playing', 2: 'Paused', 3: 'Buffering', 5: 'Ready' };
            document.getElementById('player_status').textContent = s[e.data] || '';
            playing = e.data === 1;
            document.getElementById('play_btn').textContent = playing ? '‚è∏' : '‚ñ∂';
            if (e.data === 0) socket.emit('song_ended');
          }
        }
      });
      setInterval(() => {
        if (yt && ready && playing) {
          const c = yt.getCurrentTime() || 0, t = yt.getDuration() || 0;
          document.getElementById('progress').style.width = (c / t * 100) + '%';
          document.getElementById('time_cur').textContent = fmt(c);
          document.getElementById('time_tot').textContent = fmt(t);
        }
      }, 500);

      // Sync playback time to server every 2 seconds
      setInterval(() => {
        if (yt && ready && currentRoomId) {
          socket.emit('sync_time', {
            time: yt.getCurrentTime() || 0,
            is_playing: yt.getPlayerState() === 1
          });
        }
      }, 2000);
    }

    socket.on('search_results', r => {
      const el = document.getElementById('search_results');
      if (!r.length) { el.innerHTML = '<div class="empty">No results</div>'; return; }
      el.innerHTML = r.map(s => `
        <div class="song-item">
          <div class="song-thumb"><img src="https://img.youtube.com/vi/${s.id}/mqdefault.jpg"></div>
          <div class="song-info">
            <div class="song-title">${esc(s.title)}</div>
            <div class="song-channel">${esc(s.channel || '')}</div>
          </div>
          <button class="song-add" onclick='add(${JSON.stringify(s).replace(/'/g, "\\'")})'>Add</button>
        </div>
      `).join('');
    });

    socket.on('now_playing', s => {
      const t = document.getElementById('player_title');
      const i = document.getElementById('thumb');
      const c = document.getElementById('now_playing_card');
      if (s && s.id) {
        t.textContent = s.title;
        i.src = `https://img.youtube.com/vi/${s.id}/mqdefault.jpg`;
        i.style.display = 'block';
        c.innerHTML = `<div style="text-align:center"><img src="https://img.youtube.com/vi/${s.id}/mqdefault.jpg" style="width:100%;border-radius:6px;margin-bottom:8px"><div style="font-size:13px">${esc(s.title)}</div></div>`;

        if (ready) {
          // Sync playback position for users joining mid-song
          const startAt = s.start_at || 0;
          yt.loadVideoById({ videoId: s.id, startSeconds: startAt });

          // If room is paused, pause after loading
          if (s.is_playing === false) {
            setTimeout(() => yt.pauseVideo(), 500);
          }
        }
      } else {
        t.textContent = 'Not playing';
        i.style.display = 'none';
        c.innerHTML = '<div class="empty">Nothing playing</div>';
        if (yt && ready) yt.stopVideo();
      }
    });

    socket.on('toggle_play', () => { if (yt && ready) yt.getPlayerState() === 1 ? yt.pauseVideo() : yt.playVideo(); });

    socket.on('queue_updated', q => {
      const el = document.getElementById('queue_list');
      document.getElementById('queue_count').textContent = q.length + ' song' + (q.length !== 1 ? 's' : '');
      if (!q.length) { el.innerHTML = '<div class="empty">No songs in queue</div>'; return; }
      el.innerHTML = q.map((s, i) => `
        <div class="queue-item">
          <span class="queue-num">${i + 1}</span>
          <span class="queue-title">${esc(s.title)}</span>
        </div>
      `).join('');
    });

    socket.on('user_list', u => {
      const el = document.getElementById('user_list');
      document.getElementById('user_count').textContent = u.length + ' online';
      if (!u.length) { el.innerHTML = '<div class="empty">No listeners</div>'; return; }
      el.innerHTML = u.map(n => `
        <div class="user-item">
          <div class="user-avatar">${n[0].toUpperCase()}</div>
          <span class="user-name">${esc(n)}</span>
        </div>
      `).join('');
    });

    socket.on('status', m => toast(m));

    function toast(m) {
      const t = document.getElementById('toast');
      t.textContent = m;
      t.classList.add('show');
      setTimeout(() => t.classList.remove('show'), 2000);
    }

    function esc(s) {
      const d = document.createElement('div');
      d.textContent = s;
      return d.innerHTML;
    }

    // Focus username on load
    window.onload = () => {
      const u = document.getElementById('username');
      if (u) {
        setTimeout(() => u.focus(), 100);
      }
    };

    // KEYBOARD SHORTCUTS DISABLED FOR TESTING
    // Will add back after confirming typing works
  </script>
</body>

</html>